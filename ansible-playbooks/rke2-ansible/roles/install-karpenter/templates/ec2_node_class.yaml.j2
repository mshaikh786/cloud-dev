apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: cpu-nodeclass
spec:
  instanceProfile: "{{ karpenter.cluster_name }}-instance-profile"
  amiFamily: Custom
  amiSelectorTerms:
    - id: "{{ hostvars['ec2_metadata_store']['ami_id'] }}"
  subnetSelectorTerms:
    - id: "{{ hostvars['ec2_metadata_store']['subnet_id'] }}"
  securityGroupSelectorTerms:
    - id: "{{ hostvars['ec2_metadata_store']['sg_ids'] }}"
  tags:
    Name: "karpenter-node"
    managed_by: "{{karpenter.managed_by}}"
    cluster: "{{karpenter.cluster_name}}"
  
  userData: "{{ lookup('template', 'userdata.sh.j2') | b64encode }}"